import os
import math
from math import *
import numpy as np
from scipy.stats import chisquare
import matplotlib.pyplot as plt
from scipy.optimize import curve_fit

masspoints =[
[0.2113,3.16974071429],
[0.24,3.15094083333],
[0.26,3.164873125],
[0.3,3.153],
[0.33,3.16802684211],
[0.36,3.160332],
[0.4,3.15017238095],
[0.43,3.15624176471],
[0.46,3.18822352941],
[0.5,3.19246933333],
[0.53,3.26830307692],
[0.56,3.30688692308],
[0.6,3.287213],
[0.7,3.2559525],
[0.8,4.97948647059],
[0.88,3.25090384615],
[0.9,3.17403166667],
[0.91,3.15584090909],
[0.92,3.18351882353],
[0.93,3.18278666667],
[0.94,3.18058473684],
[1.0,3.19010555556],
[1.1,3.18392],
[1.2,3.87639052632],
[1.3,3.3804475],
[1.4,4.97678428571],
[1.5,3.478336],
[1.6,3.21092428571],
[1.7,3.16422214286],
[1.8,3.36318190476],
[1.9,3.78453222222],
[2.0,3.36736],
[2.1,3.204282],
[2.2,3.207873125],
[2.3,3.7348315],
[2.4,4.28794071429],
[2.5,3.33356764706],
[2.6,3.24123583333],
[2.7,3.63779928571],
[2.8,5.0874],
[2.9,5.28966545455],
[3.0,7.00826444444],
[3.02,7.78895363636],
[3.05,8.55555666667],
[3.08,9.152879375],
[3.09,9.190498125],
[3.1,9.15600642857],
[3.12,8.91841666667],
[3.15,8.08752625],
[3.2,6.557825625],
[3.3,5.01724235294],
[3.4,3.26105066667],
[3.7,3.21871333333],
[4.0,3.17041055556],
[5.0,3.19344692308],
[6.0,3.19138307692],
[7.0,3.18332],
[8.0,3.16727705882],
[8.5,3.20162],
]

'''
combine -n .H2A4Mu_mA_3.1000_GeV_Asimov_29 -m 125 -M AsymptoticLimits --toysFrequentist --cl 0.95 -s -1 --run blind Datacards/datacard_H2A4Mu_mA_3.1000_GeV.txt > macros/sh/OutPut_3.1000_Asimov_29.txt
'''

data = []
data_median = []

i = 0
for mass in masspoints:
    i +=1
    #print mass[0]
    mass_string = "%.4f"%(mass[0])

    combine_command = "combine -n .H2A4Mu_mA_%s_GeV_Asimov_29 -m 125 -M AsymptoticLimits --toysFrequentist --cl 0.95 -s -1 --run blind Datacards/datacard_H2A4Mu_mA_%s_GeV.txt > macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt"%(mass_string, mass_string, mass_string)
    #print combine_command
    os.system(combine_command)

    """
    Expected  2.5%: r < 2.2321
    Expected 16.0%: r < 3.2156
    Expected 50.0%: r < 4.9688
    Expected 84.0%: r < 7.9396
    Expected 97.5%: r < 12.1966
    """

    ## get the data from the output file
    limit_2p5  = float(os.popen('grep "Expected  2.5" macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt'%(mass_string)).read().split()[-1])
    limit_16   = float(os.popen('grep "Expected 16.0" macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt'%(mass_string)).read().split()[-1])
    limit_50   = float(os.popen('grep "Expected 50.0" macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt'%(mass_string)).read().split()[-1])
    limit_84   = float(os.popen('grep "Expected 84.0" macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt'%(mass_string)).read().split()[-1])
    limit_97p5 = float(os.popen('grep "Expected 97.5" macros/sh/OutPut_%s_Asimov_29_20181002_SD.txt'%(mass_string)).read().split()[-1])
    """
    print limit_2p5
    print limit_16
    print limit_50
    print limit_84
    print limit_97p5
    """
    ## print the results
    print "[", mass_string, ",", limit_2p5, ",", limit_16, ",", limit_50, ",", limit_84, ",", limit_97p5, "]"
    data.append((mass_string, limit_2p5, limit_16, limit_50, limit_84, limit_97p5))
    data_median.append((float(mass_string), float(limit_50)))

## fitting machinery
xdata = [i[0] for i in data_median]
ydata = [i[1] for i in data_median]
print xdata
print ydata

## fit the data
def myGaus(x, mu, sigma):
    print "type x", type(x)
    return 1/( sigma * np.sqrt(2.0*pi) ) * np.exp( - (x - mu)*(x - mu) / 2.0/sigma/sigma )

def func(x, a, b, c, d, e, f, g, h, i, j):
    return a*myGaus(x, b, c) + d*myGaus(x, e, f) + g*myGaus(x, h, i) + j

popt, pcov = curve_fit(func, np.array(xdata), np.array(ydata), bounds=([0,0,0,0,0,0,0,0,0,0],[3., 1., 0.5, 10, 10, 3, 10,10,10,10]))
plt.plot(xdata, ydata, 'o', label='data', markersize=3)
plt.plot(xdata, func(np.array(xdata), *popt), 'r-', label='fit')
plt.xlabel('x')
plt.ylabel('y')
plt.legend()

print "Fit parameters", popt
print "Fit covariance matrix", pcov

plt.show()


data_scenario_1 = [
[ 0.2113 , 0.9524 , 1.491 , 2.5938 , 4.6408 , 7.8619 ],
[ 0.2400 , 1.1953 , 1.8016 , 3.0 , 5.1764 , 8.5985 ],
[ 0.2600 , 1.3781 , 2.0484 , 3.3281 , 5.6364 , 9.1745 ],
[ 0.3000 , 1.5282 , 2.2763 , 3.6562 , 6.1047 , 9.8256 ],
[ 0.3300 , 1.5478 , 2.3055 , 3.7031 , 6.2125 , 10.0381 ],
[ 0.3600 , 1.5398 , 2.3058 , 3.7188 , 6.2387 , 10.0804 ],
[ 0.4000 , 1.4804 , 2.2122 , 3.6094 , 6.1127 , 9.8738 ],
[ 0.4300 , 1.4282 , 2.1458 , 3.5156 , 5.982 , 9.7341 ],
[ 0.4600 , 1.3901 , 2.0885 , 3.4219 , 5.8497 , 9.5868 ],
[ 0.5000 , 1.3447 , 2.0426 , 3.375 , 5.7696 , 9.4906 ],
[ 0.5300 , 1.3385 , 2.0332 , 3.3594 , 5.7429 , 9.4816 ],
[ 0.5600 , 1.3385 , 2.0332 , 3.3594 , 5.7697 , 9.486 ],
[ 0.6000 , 1.3385 , 2.0332 , 3.3594 , 5.7429 , 9.4816 ],
[ 0.7000 , 1.3705 , 2.0703 , 3.4062 , 5.823 , 9.5785 ],
[ 0.8000 , 1.46 , 2.1935 , 3.5938 , 6.0863 , 9.9068 ],
[ 0.8800 , 1.4663 , 2.203 , 3.6094 , 6.1127 , 9.9498 ],
[ 0.9000 , 1.4663 , 2.203 , 3.6094 , 6.1127 , 9.9498 ],
[ 0.9100 , 1.4868 , 2.2218 , 3.625 , 6.1392 , 9.9929 ],
[ 0.9200 , 1.4996 , 2.241 , 3.6562 , 6.1921 , 10.079 ],
[ 0.9300 , 1.5125 , 2.2601 , 3.6875 , 6.245 , 10.0876 ],
[ 0.9400 , 1.5189 , 2.2697 , 3.7031 , 6.2715 , 10.1303 ],
[ 1.0000 , 1.6743 , 2.463 , 3.9688 , 6.5948 , 10.5717 ],
[ 1.1000 , 1.6523 , 2.4432 , 3.9531 , 6.6319 , 10.6315 ],
[ 1.2000 , 1.7205 , 2.5493 , 4.0781 , 6.7766 , 10.8631 ],
[ 1.3000 , 1.8329 , 2.6691 , 4.2656 , 7.0541 , 11.2608 ],
[ 1.4000 , 1.9067 , 2.7965 , 4.4375 , 7.303 , 11.5592 ],
[ 1.5000 , 2.0234 , 2.938 , 4.625 , 7.5378 , 11.8716 ],
[ 1.6000 , 2.0781 , 3.0175 , 4.75 , 7.7415 , 12.1924 ],
[ 1.7000 , 2.1656 , 3.1291 , 4.9062 , 7.9571 , 12.4716 ],
[ 1.8000 , 2.2001 , 3.179 , 4.9844 , 8.044 , 12.6562 ],
[ 1.9000 , 2.2544 , 3.2416 , 5.0625 , 8.1701 , 12.7417 ],
[ 2.0000 , 2.2544 , 3.2416 , 5.0625 , 8.1701 , 12.7417 ],
[ 2.1000 , 2.2474 , 3.2316 , 5.0469 , 8.1449 , 12.7586 ],
[ 2.2000 , 2.2196 , 3.1916 , 4.9844 , 8.0838 , 12.6702 ],
[ 2.3000 , 2.1588 , 3.1192 , 4.8906 , 7.9317 , 12.4319 ],
[ 2.4000 , 2.0918 , 3.0373 , 4.7812 , 7.7925 , 12.2726 ],
[ 2.5000 , 2.0054 , 2.9263 , 4.625 , 7.5378 , 11.9735 ],
[ 2.6000 , 1.9202 , 2.8162 , 4.4688 , 7.3544 , 11.6406 ],
[ 2.7000 , 1.8362 , 2.7068 , 4.3125 , 7.0972 , 11.3746 ],
[ 2.8000 , 1.7798 , 2.6372 , 4.2188 , 7.0102 , 11.1467 ],
[ 2.9000 , 1.8828 , 2.7754 , 4.4219 , 7.3125 , 11.6732 ],
[ 3.0000 , 3.1311 , 4.5327 , 7.0312 , 11.2913 , 17.3609 ],
[ 3.0200 , 3.9276 , 5.6045 , 8.5938 , 13.5607 , 20.6323 ],
[ 3.0500 , 5.7957 , 8.0968 , 12.0625 , 18.4574 , 27.2841 ],
[ 3.0800 , 7.4414 , 10.2759 , 15.0 , 22.4738 , 32.5971 ],
[ 3.0900 , 7.4104 , 10.2331 , 14.9375 , 22.4397 , 32.5846 ],
[ 3.1000 , 6.9275 , 9.5933 , 14.1875 , 21.4827 , 31.3817 ],
[ 3.1200 , 5.3748 , 7.6468 , 11.5625 , 17.8766 , 26.7208 ],
[ 3.1500 , 3.418 , 4.9629 , 7.8125 , 12.6082 , 19.4889 ],
[ 3.2000 , 1.8801 , 2.8781 , 4.7188 , 7.9915 , 12.9087 ],
[ 3.3000 , 1.2322 , 1.8995 , 3.2188 , 5.6565 , 9.4327 ],
[ 3.4000 , 1.1104 , 1.732 , 2.9609 , 5.2506 , 8.8278 ],
[ 3.7000 , 1.2391 , 1.8927 , 3.1406 , 5.4441 , 9.0048 ],
[ 4.0000 , 0.8057 , 1.3283 , 2.3984 , 4.4443 , 7.271 ],
[ 5.0000 , 0.6957 , 1.1685 , 2.1719 , 4.1284 , 6.585 ],
[ 6.0000 , 0.7057 , 1.197 , 2.2031 , 4.1527 , 6.6795 ],
[ 7.0000 , 0.727 , 1.2241 , 2.2422 , 4.2084 , 6.7978 ],
[ 8.0000 , 0.7434 , 1.2429 , 2.2656 , 4.2344 , 6.8687 ],
[ 8.5000 , 0.7537 , 1.26 , 2.2969 , 4.2928 , 6.9634 ]
]

fitparams_scenario_1 = [ 0.18460216,  0.36087868,  0.08658201,  1.33776152,  3.08281802,  0.04873429,
  6.95849706,  2.03313206,  0.99300184,  2.21479736]


data_scenario_2 = [
[ 0.2113 , 0.9409 , 1.4857 , 2.5625 , 4.5441 , 7.6146 ],
[ 0.2400 , 1.1882 , 1.7949 , 2.9531 , 5.0484 , 8.2736 ],
[ 0.2600 , 1.3649 , 2.0331 , 3.2656 , 5.4785 , 8.7826 ],
[ 0.3000 , 1.5302 , 2.2556 , 3.5938 , 5.9717 , 9.4179 ],
[ 0.3300 , 1.5425 , 2.2856 , 3.6562 , 6.0755 , 9.5817 ],
[ 0.3600 , 1.5425 , 2.2856 , 3.6562 , 6.0755 , 9.6605 ],
[ 0.4000 , 1.4751 , 2.1926 , 3.5625 , 5.9481 , 9.4973 ],
[ 0.4300 , 1.4363 , 2.1349 , 3.4688 , 5.8193 , 9.3288 ],
[ 0.4600 , 1.3711 , 2.0678 , 3.375 , 5.7158 , 9.1972 ],
[ 0.5000 , 1.3521 , 2.0313 , 3.3281 , 5.6364 , 9.1045 ],
[ 0.5300 , 1.3328 , 2.0133 , 3.3125 , 5.61 , 9.0617 ],
[ 0.5600 , 1.3457 , 2.0218 , 3.3125 , 5.61 , 9.0617 ],
[ 0.6000 , 1.3328 , 2.0133 , 3.3125 , 5.61 , 9.0617 ],
[ 0.7000 , 1.3647 , 2.0504 , 3.3594 , 5.6893 , 9.1899 ],
[ 0.8000 , 1.4686 , 2.183 , 3.5469 , 5.9503 , 9.4634 ],
[ 0.8800 , 1.4612 , 2.1835 , 3.5625 , 5.9765 , 9.543 ],
[ 0.9000 , 1.4612 , 2.1835 , 3.5625 , 5.9765 , 9.581 ],
[ 0.9100 , 1.4816 , 2.2023 , 3.5781 , 6.0028 , 9.623 ],
[ 0.9200 , 1.4945 , 2.2215 , 3.6094 , 6.0552 , 9.6302 ],
[ 0.9300 , 1.501 , 2.2477 , 3.625 , 6.0814 , 9.6719 ],
[ 0.9400 , 1.5074 , 2.2574 , 3.6406 , 6.1076 , 9.7135 ],
[ 1.0000 , 1.6632 , 2.4518 , 3.9062 , 6.4287 , 10.1327 ],
[ 1.1000 , 1.6479 , 2.4242 , 3.9062 , 6.4287 , 10.2179 ],
[ 1.2000 , 1.7164 , 2.5302 , 4.0312 , 6.6344 , 10.413 ],
[ 1.3000 , 1.806 , 2.6488 , 4.2031 , 6.8502 , 10.7424 ],
[ 1.4000 , 1.9141 , 2.7792 , 4.375 , 7.0955 , 11.0241 ],
[ 1.5000 , 2.007 , 2.8999 , 4.5469 , 7.338 , 11.3932 ],
[ 1.6000 , 2.0691 , 3.0101 , 4.6875 , 7.5649 , 11.6411 ],
[ 1.7000 , 2.15 , 3.1125 , 4.8281 , 7.7149 , 11.9058 ],
[ 1.8000 , 2.1848 , 3.1628 , 4.9062 , 7.8397 , 12.0985 ],
[ 1.9000 , 2.2321 , 3.2156 , 4.9688 , 7.9396 , 12.1406 ],
[ 2.0000 , 2.2391 , 3.2257 , 4.9844 , 7.9646 , 12.1787 ],
[ 2.1000 , 2.2321 , 3.2156 , 4.9688 , 7.9396 , 12.1406 ],
[ 2.2000 , 2.204 , 3.1751 , 4.9062 , 7.8397 , 12.0985 ],
[ 2.3000 , 2.1431 , 3.1024 , 4.8125 , 7.7283 , 11.8826 ],
[ 2.4000 , 2.0944 , 3.0115 , 4.7031 , 7.5901 , 11.7323 ],
[ 2.5000 , 1.9893 , 2.9084 , 4.5469 , 7.338 , 11.4439 ],
[ 2.6000 , 1.9277 , 2.7991 , 4.4062 , 7.1462 , 11.1029 ],
[ 2.7000 , 1.8262 , 2.6783 , 4.25 , 6.9266 , 10.8153 ],
[ 2.8000 , 1.7859 , 2.6192 , 4.1562 , 6.807 , 10.6795 ],
[ 2.9000 , 1.8665 , 2.7374 , 4.3438 , 7.114 , 11.1613 ],
[ 3.0000 , 3.1294 , 4.4867 , 6.9062 , 10.953 , 16.5264 ],
[ 3.0200 , 3.8892 , 5.5237 , 8.4375 , 13.1124 , 19.5318 ],
[ 3.0500 , 5.6611 , 7.921 , 11.6875 , 17.604 , 25.5211 ],
[ 3.0800 , 7.1875 , 9.8828 , 14.375 , 21.1936 , 30.0779 ],
[ 3.0900 , 7.1562 , 9.8398 , 14.3125 , 21.1585 , 29.9817 ],
[ 3.1000 , 6.7061 , 9.3007 , 13.625 , 20.3051 , 28.9703 ],
[ 3.1200 , 5.2878 , 7.4541 , 11.1875 , 17.1185 , 24.9748 ],
[ 3.1500 , 3.3633 , 4.9173 , 7.6875 , 12.2226 , 18.5839 ],
[ 3.2000 , 1.8916 , 2.8419 , 4.6562 , 7.8115 , 12.4233 ],
[ 3.3000 , 1.2142 , 1.8872 , 3.1719 , 5.5235 , 9.0978 ],
[ 3.4000 , 1.1071 , 1.7168 , 2.9219 , 5.1348 , 8.5041 ],
[ 3.7000 , 1.2358 , 1.8771 , 3.1016 , 5.3022 , 8.6572 ],
[ 4.0000 , 0.7979 , 1.3154 , 2.375 , 4.363 , 7.1997 ],
[ 5.0000 , 0.6907 , 1.1658 , 2.1562 , 4.0299 , 6.5371 ],
[ 6.0000 , 0.7067 , 1.19 , 2.1797 , 4.0737 , 6.6082 ],
[ 7.0000 , 0.728 , 1.2172 , 2.2188 , 4.1114 , 6.7263 ],
[ 8.0000 , 0.7419 , 1.2316 , 2.2344 , 4.1581 , 6.7738 ],
[ 8.5000 , 0.7611 , 1.2548 , 2.2656 , 4.1982 , 6.8684 ]
]

fitparams_scenario_2 = [ 0.17999561,  0.36167031,  0.08634227,  1.2954662,   3.0827831 ,  0.04967494,
  6.80274716,  2.02962931,  0.99072903,  2.19155164]

